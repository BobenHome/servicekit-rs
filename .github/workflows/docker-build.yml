# .github/workflows/docker-build.yml

name: Docker Build and Push

# 1. 触发器 (Trigger)
on:
  push:
    branches: [ "main" ]

# 2. 权限 (Permissions)
permissions:
  contents: read      # 需要读取代码库
  packages: write     # 需要写入 (推送) 镜像到 GHCR

# 3. 任务 (Jobs)
# --------------------
jobs:
  build-and-push:
    name: Build and Push Image
    # 使用最新的 Ubuntu 运行器
    runs-on: ubuntu-latest

    steps:
      # 步骤 1: 检出代码 (Checkout)
      - name: Check out repository
        uses: actions/checkout@v4

      # 步骤 2: 设置 QEMU (用于多架构构建)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 步骤 3: 设置 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤 4: 登录到 GitHub Container Registry (GHCR)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }} # 您的 GitHub 用户名或组织名
          password: ${{ secrets.GITHUB_TOKEN }}  # GitHub 自动提供的 Token

      # 步骤 5: 提取 Docker 元数据 (自动生成标签)
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          # 镜像名称的格式为: ghcr.io/<用户名>/<仓库名>
          images: ghcr.io/${{ github.repository }}

      # 步骤 6: 构建并推送镜像
      # --------------------------
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .  # 使用当前目录作为构建上下文
          file: ./Dockerfile # Dockerfile 的路径
          platforms: linux/amd64
          push: true  # 确保执行 "push" 操作
          tags: ${{ steps.meta.outputs.tags }}  # 使用上一步生成的标签
          labels: ${{ steps.meta.outputs.labels }} # 添加推荐的 OCI 标签